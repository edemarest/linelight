services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: ["redis-server", "--appendonly", "yes"]

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file:
      - backend/.env
    environment:
      - PORT=4000
      - MBTA_API_BASE_URL=${MBTA_API_BASE_URL:-https://api-v3.mbta.com}
      # Increase MBTA rate limit window to 60s and allow up to 1000 requests/minute
      - MBTA_RATE_LIMIT_WINDOW_MS=${MBTA_RATE_LIMIT_WINDOW_MS:-60000}
      - MBTA_RATE_LIMIT_MAX_REQUESTS=${MBTA_RATE_LIMIT_MAX_REQUESTS:-1000}
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - MBTA_MAX_RETRIES=${MBTA_MAX_RETRIES:-4}
      - MBTA_RETRY_BASE_DELAY_MS=${MBTA_RETRY_BASE_DELAY_MS:-500}
      - MBTA_RETRY_MAX_DELAY_MS=${MBTA_RETRY_MAX_DELAY_MS:-7500}
    depends_on:
      - redis
    ports:
      - "4000:4000"
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:4000}
    environment:
      - PORT=3000
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:4000}
    depends_on:
      - backend
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  redis-data:
